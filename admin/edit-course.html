<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Course - York Music Forum</title>
  <link href="https://fonts.googleapis.com/css2?family=Abeezee&family=Muli&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Muli', sans-serif;
      background: #fff;
      color: #000;
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    header img {
      height: 50px;
      margin-right: 1rem;
    }
    h1 {
      font-family: 'Abeezee', serif;
      color: #8b1453;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Muli', sans-serif;
    }
    button:hover {
      background-color: #a02167;
    }
    .content-box {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .content-box textarea {
      width: 100%;
      height: 100px;
      font-family: 'Muli', sans-serif;
      font-size: 1rem;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .content-box input[type="file"] {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <img src="../ymf-logo.png" alt="York Music Forum Logo" />
    <h1>Edit Course</h1>
  </header>

  <div id="course-title-container">
    <label for="course-title">Course Title:</label><br />
    <input type="text" id="course-title" style="width: 100%; font-size: 1.2rem; padding: 0.3rem;" />
  </div>

  <h2>Content Boxes</h2>
  <div id="content-boxes"></div>

  <button id="add-text-box">Add Text Box</button>
  <button id="add-image-box">Add Image Box</button>
  <button id="add-audio-box">Add Audio Box</button>
  <br /><br />
  <button id="save-course">Save Course</button>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Firebase config - replace with your project's config if needed
    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-online-course-platform.firebaseapp.com",
      projectId: "ymf-online-course-platform",
      storageBucket: "ymf-online-course-platform.appspot.com",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    const courseTitleInput = document.getElementById('course-title');
    const contentBoxesDiv = document.getElementById('content-boxes');
    const addTextBtn = document.getElementById('add-text-box');
    const addImageBtn = document.getElementById('add-image-box');
    const addAudioBtn = document.getElementById('add-audio-box');
    const saveBtn = document.getElementById('save-course');

    let contentBoxes = [];

    function createContentBox(type, content = '') {
      const boxId = 'box-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

      const div = document.createElement('div');
      div.className = 'content-box';
      div.dataset.id = boxId;
      div.dataset.type = type;

      if (type === 'text') {
        const textarea = document.createElement('textarea');
        textarea.value = content;
        div.appendChild(textarea);
      } else if (type === 'image') {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';

        const preview = document.createElement('img');
        preview.style.maxWidth = '100%';
        preview.style.display = content ? 'block' : 'none';
        preview.src = content || '';

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });

        div.appendChild(fileInput);
        div.appendChild(preview);
      } else if (type === 'audio') {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'audio/*';

        const audioPreview = document.createElement('audio');
        audioPreview.controls = true;
        audioPreview.style.display = content ? 'block' : 'none';
        audioPreview.src = content || '';

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              audioPreview.src = e.target.result;
              audioPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });

        div.appendChild(fileInput);
        div.appendChild(audioPreview);
      }

      // Add delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.style.marginTop = '0.5rem';
      deleteBtn.addEventListener('click', () => {
        contentBoxesDiv.removeChild(div);
        contentBoxes = contentBoxes.filter(box => box.id !== boxId);
      });
      div.appendChild(deleteBtn);

      contentBoxesDiv.appendChild(div);

      // Add to contentBoxes array
      contentBoxes.push({ id: boxId, type, element: div });

      return div;
    }

    // Load course data from Firestore
    async function loadCourse() {
      if (!courseId) {
        alert('No course ID specified');
        return;
      }
      try {
        const doc = await db.collection('courses').doc(courseId).get();
        if (!doc.exists) {
          alert('Course not found');
          return;
        }
        const course = doc.data();
        courseTitleInput.value = course.title || '';

        // Clear existing boxes
        contentBoxesDiv.innerHTML = '';
        contentBoxes = [];

        if (course.content && Array.isArray(course.content)) {
          for (const box of course.content) {
            createContentBox(box.type, box.content);
          }
        }
      } catch (error) {
        console.error('Error loading course:', error);
        alert('Error loading course data.');
      }
    }

    // Upload file to Firebase Storage and return URL
    async function uploadFile(file, path) {
      const storageRef = storage.ref();
      const fileRef = storageRef.child(path);
      await fileRef.put(file);
      return await fileRef.getDownloadURL();
    }

    // Save course data to Firestore
    async function saveCourse() {
      const title = courseTitleInput.value.trim();
      if (!title) {
        alert('Course title cannot be empty');
        return;
      }

      // Prepare content array with uploaded URLs
      const contentData = [];

      for (const box of contentBoxes) {
        const type = box.type;
        const el = box.element;
        if (type === 'text') {
          const text = el.querySelector('textarea').value.trim();
          contentData.push({ type: 'text', content: text });
        } else if (type === 'image' || type === 'audio') {
          const fileInput = el.querySelector('input[type="file"]');
          const previewEl = type === 'image' ? el.querySelector('img') : el.querySelector('audio');

          if (fileInput.files.length > 0) {
            // Upload new file
            const file = fileInput.files[0];
            const filePath = `courses/${courseId}/${type}s/${Date.now()}_${file.name}`;
            try {
              const url = await uploadFile(file, filePath);
              contentData.push({ type, content: url });
            } catch (error) {
              alert(`Failed to upload ${type} file: ${error.message}`);
              return;
            }
          } else if (previewEl.src) {
            // Use existing URL if no new file selected
            contentData.push({ type, content: previewEl.src });
          } else {
            contentData.push({ type, content: '' });
          }
        }
      }

      try {
        await db.collection('courses').doc(courseId).set({
          title,
          content: contentData,
          updatedAt: new Date()
        }, { merge: true });

        alert('Course saved successfully!');
      } catch (error) {
        console.error('Error saving course:', error);
        alert('Failed to save course.');
      }
    }

    // Button event listeners
    addTextBtn.addEventListener('click', () => createContentBox('text'));
    addImageBtn.addEventListener('click', () => createContentBox('image'));
    addAudioBtn.addEventListener('click', () => createContentBox('audio'));
    saveBtn.addEventListener('click', saveCourse);

    // Load course on page load
    window.onload = loadCourse;
  </script>
</body>
</html>
