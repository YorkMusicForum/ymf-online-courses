<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Course - York Music Forum</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Abeezee&family=Muli&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Muli', sans-serif;
      margin: 20px;
      background: #fff;
      color: #000;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    header img {
      height: 50px;
      margin-right: 15px;
    }
    h1 {
      font-family: 'Abeezee', serif;
      color: #8b1453;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 4px;
      font-family: 'Muli', sans-serif;
    }
    button:hover {
      background-color: #6e0f3f;
    }
    .content-box {
      border: 1px solid #ddd;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 6px;
    }
    .content-box textarea {
      width: 100%;
      min-height: 60px;
      font-family: 'Muli', sans-serif;
      font-size: 14px;
      margin-top: 5px;
    }
    .content-box label {
      font-weight: bold;
      font-family: 'Abeezee', serif;
    }
    .content-box img,
    .content-box audio {
      max-width: 100%;
      margin-top: 10px;
    }
    .upload-label {
      display: block;
      margin-top: 8px;
      font-family: 'Muli', sans-serif;
      font-size: 14px;
      cursor: pointer;
      color: #8b1453;
    }
    .upload-label:hover {
      text-decoration: underline;
    }
    .file-input {
      display: none;
    }
    #saveCourseBtn {
      margin-top: 20px;
      font-size: 16px;
      padding: 10px 20px;
    }
    #deleteCourseBtn {
      margin-left: 10px;
      background-color: #c1272d;
    }
    #deleteCourseBtn:hover {
      background-color: #911b1f;
    }
  </style>
</head>
<body>
  <header>
    <img src="ymf-logo.png" alt="York Music Forum Logo" />
    <h1>Edit Course</h1>
  </header>

  <div>
    <label for="courseTitle"><strong>Course Title:</strong></label><br />
    <input type="text" id="courseTitle" style="width: 100%; padding: 8px; font-size: 18px;" />
  </div>

  <div id="contentBoxesContainer" style="margin-top: 25px;"></div>

  <button id="addTextBoxBtn">+ Add Text Box</button>
  <button id="addImageBoxBtn">+ Add Image Box</button>
  <button id="addAudioBoxBtn">+ Add Audio Box</button>

  <br />

  <button id="saveCourseBtn">Save Course</button>
  <button id="deleteCourseBtn">Delete Course</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Firebase config - your project
    const firebaseConfig = {
      apiKey: "AIzaSyCp94HHzIFiZh5kZREi7ZIVVL67IMnHEXw",
      authDomain: "ymf-online-course-platform.firebaseapp.com",
      projectId: "ymf-online-course-platform",
      storageBucket: "ymf-online-course-platform.appspot.com",
      messagingSenderId: "820655157281",
      appId: "1:820655157281:web:9713621443c068abd73360"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Get course ID from URL (e.g. edit-course.html?id=COURSEID)
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    if (!courseId) {
      alert("No course ID specified in URL.");
      window.location.href = "admin.html"; // Redirect back to admin or course list
    }

    // Keep track of content boxes in memory as array of objects
    let contentBoxes = [];

    // Check user login status
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Not logged in, redirect to login page
        window.location.href = "login.html";
      } else {
        // Load course data
        loadCourse();
      }
    });

    // Load course data from Firestore
    function loadCourse() {
      db.collection('courses').doc(courseId).get()
        .then(doc => {
          if (!doc.exists) {
            alert("Course not found.");
            window.location.href = "admin.html";
            return;
          }
          const course = doc.data();
          document.getElementById('courseTitle').value = course.title || '';
          contentBoxes = course.contentBoxes || [];
          renderContentBoxes();
        })
        .catch(error => {
          alert("Error loading course: " + error.message);
        });
    }

    // Render all content boxes on page
    function renderContentBoxes() {
      const container = document.getElementById('contentBoxesContainer');
      container.innerHTML = ''; // Clear existing

      contentBoxes.forEach((box, index) => {
        const boxDiv = document.createElement('div');
        boxDiv.className = 'content-box';
        boxDiv.dataset.index = index;

        // Common delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete Box';
        deleteBtn.style.float = 'right';
        deleteBtn.onclick = () => {
          if (confirm('Delete this content box?')) {
            contentBoxes.splice(index, 1);
            renderContentBoxes();
          }
        };
        boxDiv.appendChild(deleteBtn);

        if (box.type === 'text') {
          const label = document.createElement('label');
          label.textContent = 'Text Content:';
          boxDiv.appendChild(label);

          const textarea = document.createElement('textarea');
          textarea.value = box.text || '';
          textarea.oninput = e => {
            contentBoxes[index].text = e.target.value;
          };
          boxDiv.appendChild(textarea);

        } else if (box.type === 'image') {
          const label = document.createElement('label');
          label.textContent = 'Image:';
          boxDiv.appendChild(label);

          if (box.url) {
            const img = document.createElement('img');
            img.src = box.url;
            img.alt = "Uploaded image";
            boxDiv.appendChild(img);
          }

          // Upload new image file input
          const uploadLabel = document.createElement('label');
          uploadLabel.textContent = 'Upload/change image';
          uploadLabel.className = 'upload-label';

          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.className = 'file-input';
          fileInput.onchange = e => {
            const file = e.target.files[0];
            if (file) {
              uploadFile(file, 'images').then(url => {
                contentBoxes[index].url = url;
                renderContentBoxes();
              }).catch(err => {
                alert('Upload failed: ' + err.message);
              });
            }
          };

          uploadLabel.appendChild(fileInput);
          boxDiv.appendChild(uploadLabel);

        } else if (box.type === 'audio') {
          const label = document.createElement('label');
          label.textContent = 'Audio:';
          boxDiv.appendChild(label);

          if (box.url) {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = box.url;
            boxDiv.appendChild(audio);
          }

          // Upload new audio file input
          const uploadLabel = document.createElement('label');
          uploadLabel.textContent = 'Upload/change audio';
          uploadLabel.className = 'upload-label';

          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'audio/*';
          fileInput.className = 'file-input';
          fileInput.onchange = e => {
            const file = e.target.files[0];
            if (file) {
              uploadFile(file, 'audio').then(url => {
                contentBoxes[index].url = url;
                renderContentBoxes();
              }).catch(err => {
                alert('Upload failed: ' + err.message);
              });
            }
          };

          uploadLabel.appendChild(fileInput);
          boxDiv.appendChild(uploadLabel);
        }

        container.appendChild(boxDiv);
      });
    }

    // Upload file to Firebase Storage in given folder and return download URL
    function uploadFile(file, folder) {
      return new Promise((resolve, reject) => {
        const user = auth.currentUser;
        if (!user) {
          reject(new Error('User not authenticated.'));
          return;
        }

        const storageRef = storage.ref();
        // Unique filename using course ID + timestamp + original name
        const filename = `${courseId}/${folder}/${Date.now()}_${file.name}`;
        const fileRef = storageRef.child(filename);

        const uploadTask = fileRef.put(file);

        uploadTask.on('state_changed', 
          snapshot => {
            // You can show upload progress here if you want
          },
          error => {
            reject(error);
          },
          () => {
            uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
              resolve(downloadURL);
            });
          }
        );
      });
    }

    // Add new empty text box
    document.getElementById('addTextBoxBtn').onclick = () => {
      contentBoxes.push({ type: 'text', text: '' });
      renderContentBoxes();
    };

    // Add new empty image box
    document.getElementById('addImageBoxBtn').onclick = () => {
      contentBoxes.push({ type: 'image', url: '' });
      renderContentBoxes();
    };

    // Add new empty audio box
    document.getElementById('addAudioBoxBtn').onclick = () => {
      contentBoxes.push({ type: 'audio', url: '' });
      renderContentBoxes();
    };

    // Save course data to Firestore
    document.getElementById('saveCourseBtn').onclick = () => {
      const title = document.getElementById('courseTitle').value.trim();
      if (!title) {
        alert('Please enter a course title.');
        return;
      }
      db.collection('courses').doc(courseId).set({
        title: title,
        contentBoxes: contentBoxes
      }).then(() => {
        alert('Course saved successfully.');
      }).catch(error => {
        alert('Error saving course: ' + error.message);
      });
    };

    // Delete course and redirect back to admin
    document.getElementById('deleteCourseBtn').onclick = () => {
      if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        db.collection('courses').doc(courseId).delete()
          .then(() => {
            alert('Course deleted.');
            window.location.href = 'admin.html';
          })
          .catch(error => {
            alert('Error deleting course: ' + error.message);
          });
      }
    };

  </script>
</body>
</html>
