<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Edit Course - YMF Admin</title>

<!-- YMF Fonts & Colors -->
<link href="https://fonts.googleapis.com/css2?family=Abeezee&family=Muli&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Muli', sans-serif;
    background: #fff;
    color: #333;
    margin: 0; padding: 20px;
  }
  header {
    display: flex; align-items: center; gap: 15px;
    margin-bottom: 30px;
  }
  header img {
    height: 50px;
  }
  header h1 {
    font-family: 'Abeezee', serif;
    color: #8b1453;
    margin: 0;
  }
  button {
    background: #8b1453;
    color: white;
    border: none;
    padding: 8px 15px;
    cursor: pointer;
    margin-right: 8px;
    font-weight: bold;
    border-radius: 4px;
  }
  button:hover {
    background: #a12060;
  }
  .blocks-container {
    margin-top: 20px;
    max-width: 800px;
  }
  .block {
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 6px;
    position: relative;
  }
  .block-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
  }
  .block-type {
    font-weight: bold;
    color: #8b1453;
  }
  .delete-block {
    background: transparent;
    border: none;
    color: #c00;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
  }
  /* Quill editor */
  .ql-toolbar {
    border-radius: 6px 6px 0 0;
  }
  .ql-container {
    border-radius: 0 0 6px 6px;
    min-height: 120px;
  }
  input[type="text"], input[type="url"] {
    width: 100%;
    padding: 6px 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #8b1453;
  }
  .upload-info {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }
  .save-btn-container {
    margin-top: 25px;
  }
</style>

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />

</head>
<body>

<header>
  <img src="../ymf-logo.png" alt="York Music Forum Logo" />
  <h1>YMF Admin Dashboard - Edit Course</h1>
</header>

<div>
  <button id="addTextBtn">Add Text Block</button>
  <button id="addImageBtn">Add Image Block</button>
  <button id="addAudioBtn">Add Audio Block</button>
</div>

<div class="blocks-container" id="blocksContainer">
  <!-- Blocks will be dynamically inserted here -->
</div>

<div class="save-btn-container">
  <button id="saveCourseBtn">Save Course</button>
  <button id="cancelBtn">Cancel</button>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  // Firebase config - REPLACE with your config!
  const firebaseConfig = {
    apiKey: "AIzaSyC_KpIi1Qp79DjD_YEtOoAan3s4JuSm3rw",
    authDomain: "ymf-online-course-platform.firebaseapp.com",
    projectId: "ymf-online-course-platform",
    storageBucket: "ymf-online-course-platform.firebasestorage.app",
    messagingSenderId: "299504386356",
    appId: "1:299504386356:web:7e49e64d3aa0bd85612561"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Globals
  const blocksContainer = document.getElementById('blocksContainer');
  const addTextBtn = document.getElementById('addTextBtn');
  const addImageBtn = document.getElementById('addImageBtn');
  const addAudioBtn = document.getElementById('addAudioBtn');
  const saveCourseBtn = document.getElementById('saveCourseBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  // Quill editors storage keyed by block id
  const quillEditors = {};

  // Get course ID from URL ?id=courseId
  const urlParams = new URLSearchParams(window.location.search);
  const courseId = urlParams.get('id');
  if (!courseId) {
    alert('No course ID specified in URL.');
    window.location.href = '/admin/dashboard.html';
  }

  // Course data object
  let courseData = {
    title: '',
    blocks: []
  };

  // Initialize: load course from Firestore
  async function loadCourse() {
    const docRef = doc(db, 'courses', courseId);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      courseData = docSnap.data();
      // If no blocks array exists, create it
      if (!Array.isArray(courseData.blocks)) courseData.blocks = [];
      renderBlocks();
    } else {
      alert('Course not found.');
      window.location.href = '/admin/dashboard.html';
    }
  }

  // Render all blocks in the container
  function renderBlocks() {
    blocksContainer.innerHTML = '';
    courseData.blocks.forEach((block, index) => {
      const blockEl = createBlockElement(block, index);
      blocksContainer.appendChild(blockEl);
    });
  }

  // Create block DOM element by type
  function createBlockElement(block, index) {
    const blockDiv = document.createElement('div');
    blockDiv.className = 'block';
    blockDiv.dataset.index = index;

    // Header with block type and delete button
    const header = document.createElement('div');
    header.className = 'block-header';

    const typeLabel = document.createElement('div');
    typeLabel.className = 'block-type';
    typeLabel.textContent = block.type.charAt(0).toUpperCase() + block.type.slice(1) + ' Block';

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-block';
    delBtn.textContent = 'âœ•';
    delBtn.title = 'Delete this block';
    delBtn.onclick = () => {
      if (confirm('Delete this block?')) {
        courseData.blocks.splice(index, 1);
        renderBlocks();
      }
    };

    header.appendChild(typeLabel);
    header.appendChild(delBtn);
    blockDiv.appendChild(header);

    // Block content depending on type
    if (block.type === 'text') {
      const editorDiv = document.createElement('div');
      editorDiv.id = `editor-${index}`;
      editorDiv.style.minHeight = '120px';
      blockDiv.appendChild(editorDiv);

      // Initialize Quill editor
      setTimeout(() => {
        if (!quillEditors[index]) {
          quillEditors[index] = new Quill(editorDiv, {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ header: [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
              ]
            }
          });
          quillEditors[index].root.innerHTML = block.content || '';
        }
      }, 10);

    } else if (block.type === 'image') {
      const urlInputLabel = document.createElement('label');
      urlInputLabel.textContent = 'Image URL:';
      const urlInput = document.createElement('input');
      urlInput.type = 'url';
      urlInput.value = block.url || '';
      urlInput.placeholder = 'https://example.com/image.jpg';
      urlInput.onchange = () => {
        block.url = urlInput.value;
      };
      blockDiv.appendChild(urlInputLabel);
      blockDiv.appendChild(urlInput);

    } else if (block.type === 'audio') {
      const urlInputLabel = document.createElement('label');
      urlInputLabel.textContent = 'Audio URL:';
      const urlInput = document.createElement('input');
      urlInput.type = 'url';
      urlInput.value = block.url || '';
      urlInput.placeholder = 'https://example.com/audio.mp3';
      urlInput.onchange = () => {
        block.url = urlInput.value;
      };
      blockDiv.appendChild(urlInputLabel);
      blockDiv.appendChild(urlInput);
    }

    return blockDiv;
  }

  // Add new block functions
  addTextBtn.addEventListener('click', () => {
    courseData.blocks.push({ type: 'text', content: '' });
    renderBlocks();
  });
  addImageBtn.addEventListener('click', () => {
    courseData.blocks.push({ type: 'image', url: '' });
    renderBlocks();
  });
  addAudioBtn.addEventListener('click', () => {
    courseData.blocks.push({ type: 'audio', url: '' });
    renderBlocks();
  });

  // Save course to Firestore
  saveCourseBtn.addEventListener('click', async () => {
    // Gather content from Quill editors
    courseData.blocks.forEach((block, idx) => {
      if (block.type === 'text' && quillEditors[idx]) {
        block.content = quillEditors[idx].root.innerHTML;
      }
    });

    try {
      await setDoc(doc(db, 'courses', courseId), courseData);
      alert('Course saved successfully!');
      window.location.href = '/admin/dashboard.html';
    } catch (error) {
      alert('Error saving course: ' + error.message);
    }
  });

  // Cancel button
  cancelBtn.addEventListener('click', () => {
    if (confirm('Discard changes and return to dashboard?')) {
      window.location.href = '/admin/dashboard.html';
    }
  });

  // Load course on page load
  window.onload = loadCourse;

</script>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</body>
</html>
