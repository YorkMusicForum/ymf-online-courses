<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Course</title>

  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Muli', sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
      background: #fff;
      color: #000;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    header img {
      height: 50px;
    }
    h1 {
      font-family: 'ABeeZee', sans-serif;
      color: #8b1453;
    }
    label {
      font-weight: bold;
      margin-top: 1rem;
      display: block;
    }
    #blocks {
      margin-top: 20px;
    }
    .block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      position: relative;
    }
    .block .remove-block {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      padding: 3px 7px;
    }
    .buttons {
      margin-top: 10px;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #a71d63;
    }
  </style>
</head>
<body>

  <header>
    <img src="../ymf-logo.png" alt="YMF Logo" />
    <h1>Edit Course</h1>
  </header>

  <label for="title">Course Title</label>
  <input type="text" id="title" style="width: 100%; padding: 8px; font-size: 1.1rem;" />

  <label for="description">Course Description</label>
  <textarea id="description" rows="3" style="width: 100%; padding: 8px;"></textarea>

  <div class="buttons">
    <button id="addTextBlock">Add Text Block</button>
    <button id="addImageBlock">Add Image Block</button>
    <button id="addAudioBlock">Add Audio Block</button>
  </div>

  <div id="blocks"></div>

  <button id="saveCourse" style="margin-top: 30px;">Save Course</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC_KpIi1Qp79DjD_YEtOoAan3s4JuSm3rw",
      authDomain: "ymf-online-course-platform.firebaseapp.com",
      projectId: "ymf-online-course-platform",
      storageBucket: "ymf-online-course-platform.firebasestorage.app",
      messagingSenderId: "299504386356",
      appId: "1:299504386356:web:7e49e64d3aa0bd85612561"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const blocksContainer = document.getElementById('blocks');
    let quillEditors = []; // Keep track of all Quill editors for text blocks

    // Add Text Block with Quill editor
    document.getElementById('addTextBlock').addEventListener('click', () => {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'block';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.className = 'remove-block';
      removeBtn.onclick = () => {
        blockDiv.remove();
      };
      blockDiv.appendChild(removeBtn);

      const editorDiv = document.createElement('div');
      editorDiv.style.height = '150px';
      blockDiv.appendChild(editorDiv);

      blocksContainer.appendChild(blockDiv);

      const quill = new Quill(editorDiv, {
        theme: 'snow',
        placeholder: 'Enter formatted text here...'
      });

      quillEditors.push(quill);
    });

    // Add Image Block (upload image to Firebase Storage)
    document.getElementById('addImageBlock').addEventListener('click', () => {
      // Create a hidden file input to pick image
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      fileInput.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Create block container
        const blockDiv = document.createElement('div');
        blockDiv.className = 'block';

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.className = 'remove-block';
        removeBtn.onclick = () => {
          blockDiv.remove();
        };
        blockDiv.appendChild(removeBtn);

        const status = document.createElement('p');
        status.textContent = 'Uploading image...';
        blockDiv.appendChild(status);
        blocksContainer.appendChild(blockDiv);

        try {
          // Upload image to Firebase Storage
          const storageRef = storage.ref();
          const imagesRef = storageRef.child('course-images/' + Date.now() + '-' + file.name);
          const snapshot = await imagesRef.put(file);
          const url = await snapshot.ref.getDownloadURL();

          status.textContent = 'Upload complete.';

          const img = document.createElement('img');
          img.src = url;
          img.style.maxWidth = '100%';
          img.style.borderRadius = '6px';
          blockDiv.appendChild(img);

          // Store the URL in a custom attribute for saving later
          blockDiv.dataset.type = 'image';
          blockDiv.dataset.url = url;

        } catch (error) {
          status.textContent = 'Upload failed: ' + error.message;
        }
      };

      fileInput.click();
    });

    // Add Audio Block (just placeholder: you can customize as needed)
    document.getElementById('addAudioBlock').addEventListener('click', () => {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'block';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.className = 'remove-block';
      removeBtn.onclick = () => {
        blockDiv.remove();
      };
      blockDiv.appendChild(removeBtn);

      const audioInput = document.createElement('input');
      audioInput.type = 'text';
      audioInput.placeholder = 'Enter audio URL here';
      audioInput.style.width = '100%';
      blockDiv.appendChild(audioInput);

      blocksContainer.appendChild(blockDiv);
    });

    // Save course with blocks
    document.getElementById('saveCourse').addEventListener('click', async () => {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();

      if (!title) {
        alert('Please enter a course title.');
        return;
      }

      // Collect blocks data
      const blocks = [];
      const blockDivs = blocksContainer.querySelectorAll('.block');

      for (let i = 0; i < blockDivs.length; i++) {
        const blockDiv = blockDivs[i];
        if (blockDiv.dataset.type === 'image') {
          // Image block
          blocks.push({
            type: 'image',
            url: blockDiv.dataset.url
          });
        } else if (blockDiv.querySelector('input[type="text"]')) {
          // Audio block
          const audioUrl = blockDiv.querySelector('input[type="text"]').value.trim();
          if (audioUrl) {
            blocks.push({
              type: 'audio',
              url: audioUrl
            });
          }
        } else {
          // Text block - get content from Quill editor
          const quill = quillEditors.shift();
          if (quill) {
            const html = quill.root.innerHTML;
            blocks.push({
              type: 'text',
              content: html
            });
          }
        }
      }

      // Save to Firestore (assuming courseId is in URL param)
      const urlParams = new URLSearchParams(window.location.search);
      const courseId = urlParams.get('id');

      if (!courseId) {
        alert('No course ID found.');
        return;
      }

      try {
        await db.collection('courses').doc(courseId).update({
          title,
          description,
          contentBlocks: blocks,
          updatedAt: new Date()
        });
        alert('Course saved successfully!');
        window.location.href = 'index.html';
      } catch (error) {
        alert('Error saving course: ' + error.message);
      }
    });

    // Load course data on page load
    window.onload = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const courseId = urlParams.get('id');
      if (!courseId) {
        alert('No course ID specified.');
        return;
      }
      try {
        const doc = await db.collection('courses').doc(courseId).get();
        if (!doc.exists) {
          alert('Course not found.');
          return;
        }
        const course = doc.data();
        document.getElementById('title').value = course.title || '';
        document.getElementById('description').value = course.description || '';

        if (course.contentBlocks && course.contentBlocks.length) {
          for (const block of course.contentBlocks) {
            if (block.type === 'text') {
              addTextBlockWithContent(block.content);
            } else if (block.type === 'image') {
              addImageBlockWithUrl(block.url);
            } else if (block.type === 'audio') {
              addAudioBlockWithUrl(block.url);
            }
          }
        }
      } catch (error) {
        alert('Error loading course: ' + error.message);
      }
    };

    // Helpers for loading existing blocks
    function addTextBlockWithContent(htmlContent) {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'block';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.className = 'remove-block';
      removeBtn.onclick = () => {
        blockDiv.remove();
      };
      blockDiv.appendChild(removeBtn);

      const editorDiv = document.createElement('div');
      editorDiv.style.height = '150px';
      blockDiv.appendChild(editorDiv);

      blocksContainer.appendChild(blockDiv);

      const quill = new Quill(editorDiv, {
        theme: 'snow',
        placeholder: 'Enter formatted text here...'
      });
      quill.root.innerHTML = htmlContent;

      quillEditors.push(quill);
    }

    function addImageBlockWithUrl(url) {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'block';
      blockDiv.dataset.type = 'image';
      blockDiv.dataset.url = url;

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.className = 'remove-block';
      removeBtn.onclick = () => {
        blockDiv.remove();
      };
      blockDiv.appendChild(removeBtn);

      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.borderRadius = '6px';
      blockDiv.appendChild(img);

      blocksContainer.appendChild(blockDiv);
    }

    function addAudioBlockWithUrl(url) {
      const blockDiv = document.createElement('div');
      blockDiv.className = 'block';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.className = 'remove-block';
      removeBtn.onclick = () => {
        blockDiv.remove();
      };
      blockDiv.appendChild(removeBtn);

      const audioInput = document.createElement('input');
      audioInput.type = 'text';
      audioInput.value = url;
      audioInput.style.width = '100%';
      audioInput.placeholder = 'Enter audio URL here';
      blockDiv.appendChild(audioInput);

      blocksContainer.appendChild(blockDiv);
    }
  </script>
</body>
</html>
