<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YMF Admin - Edit Course</title>
  <link href="https://fonts.googleapis.com/css2?family=Abeezee&family=Muli&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Muli', sans-serif;
      background: #fff;
      color: #000;
      margin: 20px auto;
      max-width: 900px;
      padding: 10px 20px;
    }
    h1 {
      font-family: 'Abeezee', serif;
      color: #8b1453;
      text-align: center;
      margin-bottom: 20px;
    }
    #logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
      margin-bottom: 6px;
      color: #8b1453;
    }
    input[type="text"],
    textarea {
      width: 100%;
      font-size: 1rem;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'Muli', sans-serif;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 10px 20px;
      margin-top: 25px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 1rem;
      font-family: 'Abeezee', serif;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #6a0f3e;
    }
    .content-block {
      border: 1px solid #8b1453;
      padding: 15px;
      margin-top: 15px;
      border-radius: 6px;
      position: relative;
    }
    .content-block label {
      margin-top: 0;
    }
    .content-block textarea,
    .content-block input[type="text"] {
      width: 100%;
    }
    .remove-block-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #b33a3a;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-weight: bold;
      cursor: pointer;
    }
    .audio-preview {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <img id="logo" src="../ymf-logo.png" alt="York Music Forum Logo" />
  <h1>Edit Course</h1>

  <label for="courseTitle">Course Title</label>
  <input type="text" id="courseTitle" placeholder="Enter course title here" />

  <label for="courseDescription">Course Description</label>
  <textarea id="courseDescription" placeholder="Enter course description here"></textarea>

  <div id="contentBlocksContainer"></div>

  <button id="addTextBlock">Add Text Block</button>
  <button id="addAudioBlock">Add Audio Block</button>

  <button id="saveCourse" style="display: block; margin-top: 30px;">Save Course</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Your Firebase config here - replace with your actual config:
    const firebaseConfig = {
      apiKey: "AIzaSyC_KpIi1Qp79DjD_YEtOoAan3s4JuSm3rw",
      authDomain: "ymf-online-course-platform.firebaseapp.com",
      projectId: "ymf-online-course-platform",
      storageBucket: "ymf-online-course-platform.firebasestorage.app",
      messagingSenderId: "299504386356",
      appId: "1:299504386356:web:7e49e64d3aa0bd85612561"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('id');

    const courseTitleInput = document.getElementById('courseTitle');
    const courseDescriptionInput = document.getElementById('courseDescription');
    const contentBlocksContainer = document.getElementById('contentBlocksContainer');
    const addTextBlockBtn = document.getElementById('addTextBlock');
    const addAudioBlockBtn = document.getElementById('addAudioBlock');
    const saveCourseBtn = document.getElementById('saveCourse');

    let contentBlocks = [];

    function renderContentBlocks() {
      contentBlocksContainer.innerHTML = '';

      contentBlocks.forEach((block, index) => {
        const blockDiv = document.createElement('div');
        blockDiv.className = 'content-block';

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-block-btn';
        removeBtn.textContent = 'Ã—';
        removeBtn.title = 'Remove this block';
        removeBtn.addEventListener('click', () => {
          contentBlocks.splice(index, 1);
          renderContentBlocks();
        });
        blockDiv.appendChild(removeBtn);

        if (block.type === 'text') {
          const label = document.createElement('label');
          label.textContent = `Text Block #${index + 1}`;
          blockDiv.appendChild(label);

          const textarea = document.createElement('textarea');
          textarea.value = block.text;
          textarea.placeholder = 'Enter text content here...';
          textarea.addEventListener('input', e => {
            contentBlocks[index].text = e.target.value;
          });
          blockDiv.appendChild(textarea);

        } else if (block.type === 'audio') {
          const label = document.createElement('label');
          label.textContent = `Audio Block #${index + 1}`;
          blockDiv.appendChild(label);

          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'audio/*';

          const urlInput = document.createElement('input');
          urlInput.type = 'text';
          urlInput.placeholder = 'Or enter audio URL here...';
          urlInput.value = block.url || '';
          urlInput.style.marginTop = '6px';

          const audioPreview = document.createElement('audio');
          audioPreview.controls = true;
          audioPreview.className = 'audio-preview';
          if (block.url) {
            audioPreview.src = block.url;
          }

          fileInput.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;
            const storageRef = ref(storage, `audio/${courseId || 'new-course'}/${Date.now()}_${file.name}`);
            try {
              const snapshot = await uploadBytes(storageRef, file);
              const downloadURL = await getDownloadURL(snapshot.ref);
              contentBlocks[index].url = downloadURL;
              urlInput.value = downloadURL;
              audioPreview.src = downloadURL;
            } catch (error) {
              alert('Error uploading audio: ' + error.message);
            }
          });

          urlInput.addEventListener('input', e => {
            contentBlocks[index].url = e.target.value;
            audioPreview.src = e.target.value;
          });

          blockDiv.appendChild(fileInput);
          blockDiv.appendChild(urlInput);
          blockDiv.appendChild(audioPreview);
        }

        contentBlocksContainer.appendChild(blockDiv);
      });
    }

    async function loadCourse() {
      if (!courseId) {
        // New course, leave inputs empty
        return;
      }
      try {
        const docRef = doc(db, 'courses', courseId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          courseTitleInput.value = data.title || '';
          courseDescriptionInput.value = data.description || '';
          contentBlocks = data.contentBlocks || [];
          renderContentBlocks();
        } else {
          alert('Course not found.');
          window.location.href = '../dashboard.html';
        }
      } catch (error) {
        console.error('Error loading course:', error);
        alert('Failed to load course.');
      }
    }

    async function saveCourse() {
      if (!courseTitleInput.value.trim()) {
        alert('Please enter a course title.');
        return;
      }

      const docRef = doc(db, 'courses', courseId || courseTitleInput.value.trim().toLowerCase().replace(/\s+/g, '-'));

      const dataToSave = {
        title: courseTitleInput.value.trim(),
        description: courseDescriptionInput.value.trim(),
        contentBlocks: contentBlocks,
        updatedAt: new Date()
      };

      try {
        await setDoc(docRef, dataToSave);
        alert('Course saved successfully!');
        window.location.href = '../dashboard.html';
      } catch (error) {
        console.error('Error saving course:', error);
        alert('Error saving course, check console.');
      }
    }

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert('You must be logged in to edit courses.');
        window.location.href = '../admin.html';
      } else {
        loadCourse();
      }
    });

    addTextBlockBtn.addEventListener('click', () => {
      contentBlocks.push({ type: 'text', text: '' });
      renderContentBlocks();
    });

    addAudioBlockBtn.addEventListener('click', () => {
      contentBlocks.push({ type: 'audio', url: '' });
      renderContentBlocks();
    });

    saveCourseBtn.addEventListener('click', () => {
      saveCourse();
    });
  </script>
</body>
</html>
