<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Course</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Muli&display=swap" rel="stylesheet" />

  <!-- Quill CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: 'Muli', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fff;
      color: #000;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    header {
      display: flex;
      align-items: center;
      padding: 1rem;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
      gap: 1rem;
    }

    header img {
      height: 50px;
    }

    header h1 {
      font-family: 'ABeeZee', sans-serif;
      color: #8b1453;
      margin: 0;
    }

    main {
      padding: 2rem;
    }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-top: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      margin-top: 1rem;
      background-color: #8b1453;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    button:hover {
      background-color: #a61c66;
    }

    .content-block {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      position: relative;
    }

    .content-block button.delete-block {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: #c0392b;
      border: none;
      color: white;
      border-radius: 5px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .content-block button.delete-block:hover {
      background-color: #e74c3c;
    }

    .quill-editor {
      height: 150px;
    }

    .image-preview {
      max-width: 100%;
      height: auto;
      margin-top: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    audio {
      margin-top: 0.5rem;
      width: 100%;
      outline: none;
      border-radius: 6px;
    }

    #addBlockButtons {
      margin-top: 1.5rem;
      display: flex;
      gap: 1rem;
    }

    #addBlockButtons > button {
      flex: 1;
    }

    #saveCourseBtn, #backToDashboardBtn {
      margin-top: 2rem;
      width: 48%;
      display: inline-block;
    }

    #backToDashboardBtn {
      background-color: #777;
    }
    #backToDashboardBtn:hover {
      background-color: #555;
    }

    .uploading-text {
      font-style: italic;
      color: #666;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <img src="../ymf-logo.png" alt="York Music Forum Logo" />
    <h1>Edit Course</h1>
  </header>

  <main>
    <label for="courseTitle">Course Title</label>
    <input type="text" id="courseTitle" placeholder="Enter course title" />

    <label for="courseDescription">Course Description</label>
    <textarea id="courseDescription" rows="3" placeholder="Enter course description"></textarea>

    <div id="contentBlocksContainer"></div>

    <div id="addBlockButtons">
      <button id="addTextBlockBtn">Add Text Block</button>
      <button id="addImageBlockBtn">Add Image Block</button>
      <button id="addAudioBlockBtn">Add Audio Block</button>
    </div>

    <input type="file" id="imageUploadInput" accept="image/*" style="display:none" />
    <input type="file" id="audioUploadInput" accept="audio/*" style="display:none" />

    <button id="saveCourseBtn">Save All Changes</button>
    <button id="backToDashboardBtn">Back to Dashboard</button>
  </main>

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script>
    // Firebase config and init
    const firebaseConfig = {
      apiKey: "AIzaSyC_KpIi1Qp79DjD_YEtOoAan3s4JuSm3rw",
      authDomain: "ymf-online-course-platform.firebaseapp.com",
      projectId: "ymf-online-course-platform",
      storageBucket: "ymf-online-course-platform.firebasestorage.app",
      messagingSenderId: "299504386356",
      appId: "1:299504386356:web:7e49e64d3aa0bd85612561"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Helpers
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("id");
    if (!courseId) {
      alert("No course ID provided.");
      window.location.href = "index.html";
    }

    // DOM elements
    const courseTitleInput = document.getElementById("courseTitle");
    const courseDescriptionInput = document.getElementById("courseDescription");
    const contentBlocksContainer = document.getElementById("contentBlocksContainer");
    const addTextBlockBtn = document.getElementById("addTextBlockBtn");
    const addImageBlockBtn = document.getElementById("addImageBlockBtn");
    const addAudioBlockBtn = document.getElementById("addAudioBlockBtn");
    const imageUploadInput = document.getElementById("imageUploadInput");
    const audioUploadInput = document.getElementById("audioUploadInput");
    const saveCourseBtn = document.getElementById("saveCourseBtn");
    const backToDashboardBtn = document.getElementById("backToDashboardBtn");

    // Data
    let contentBlocks = [];
    const quillEditors = {}; // key: index of block, value: Quill instance

    // Load course from Firestore
    async function loadCourse() {
      try {
        const docRef = db.collection("courses").doc(courseId);
        const docSnap = await docRef.get();
        if (!docSnap.exists) {
          alert("Course not found");
          window.location.href = "index.html";
          return;
        }
        const courseData = docSnap.data();
        courseTitleInput.value = courseData.title || "";
        courseDescriptionInput.value = courseData.description || "";
        contentBlocks = courseData.contentBlocks || [];
        renderContentBlocks();
      } catch (error) {
        alert("Error loading course: " + error.message);
      }
    }

    // Render all content blocks
    function renderContentBlocks() {
      // Clear editors and container
      Object.values(quillEditors).forEach((quill) => {
        if (quill) quill.disable();
      });
      for (const key in quillEditors) {
        delete quillEditors[key];
      }
      contentBlocksContainer.innerHTML = "";

      contentBlocks.forEach((block, index) => {
        const blockDiv = document.createElement("div");
        blockDiv.className = "content-block";

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-block";
        deleteBtn.onclick = () => {
          contentBlocks.splice(index, 1);
          renderContentBlocks();
        };
        blockDiv.appendChild(deleteBtn);

        if (block.type === "text") {
          const editorDiv = document.createElement("div");
          editorDiv.className = "quill-editor";
          blockDiv.appendChild(editorDiv);

          // Initialize Quill editor for this block
          const quill = new Quill(editorDiv, {
            theme: "snow",
            modules: {
              toolbar: [
                [{ header: [1, 2, false] }],
                ["bold", "italic", "underline"],
                [{ list: "ordered" }, { list: "bullet" }],
                ["link"],
                ["clean"],
              ],
            },
          });

          quill.root.innerHTML = block.text || "";
          quillEditors[index] = quill;
        } else if (block.type === "image") {
          if (block.uploading) {
            const uploadingText = document.createElement("div");
            uploadingText.className = "uploading-text";
            uploadingText.textContent = "Uploading image...";
            blockDiv.appendChild(uploadingText);
          } else if (block.url) {
            const img = document.createElement("img");
            img.src = block.url;
            img.alt = "Course Image";
            img.className = "image-preview";
            blockDiv.appendChild(img);
          }
        } else if (block.type === "audio") {
          if (block.uploading) {
            const uploadingText = document.createElement("div");
            uploadingText.className = "uploading-text";
            uploadingText.textContent = "Uploading audio...";
            blockDiv.appendChild(uploadingText);
          } else if (block.url) {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.src = block.url;
            blockDiv.appendChild(audio);
          }
        }

        contentBlocksContainer.appendChild(blockDiv);
      });
    }

    // Add new text block
    addTextBlockBtn.addEventListener("click", () => {
      contentBlocks.push({ type: "text", text: "" });
      renderContentBlocks();
    });

    // Add new image block (trigger file input)
    addImageBlockBtn.addEventListener("click", () => {
      imageUploadInput.click();
    });

    // Add new audio block (trigger file input)
    addAudioBlockBtn.addEventListener("click", () => {
      audioUploadInput.click();
    });

    // Handle image upload
    imageUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const newBlock = { type: "image", url: "", uploading: true };
      contentBlocks.push(newBlock);
      renderContentBlocks();

      const index = contentBlocks.length - 1;
      const storageRef = storage.ref(`course-content/${courseId}/images/${Date.now()}_${file.name}`);
      const uploadTask = storageRef.put(file);

      uploadTask.on(
        "state_changed",
        null,
        (error) => {
          alert("Image upload failed: " + error.message);
          contentBlocks.splice(index, 1);
          renderContentBlocks();
        },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            contentBlocks[index].url = downloadURL;
            delete contentBlocks[index].uploading;
            renderContentBlocks();
          });
        }
      );

      imageUploadInput.value = "";
    });

    // Handle audio upload
    audioUploadInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const newBlock = { type: "audio", url: "", uploading: true };
      contentBlocks.push(newBlock);
      renderContentBlocks();

      const index = contentBlocks.length - 1;
      const storageRef = storage.ref(`course-content/${courseId}/audio/${Date.now()}_${file.name}`);
      const uploadTask = storageRef.put(file);

      uploadTask.on(
        "state_changed",
        null,
        (error) => {
          alert("Audio upload failed: " + error.message);
          contentBlocks.splice(index, 1);
          renderContentBlocks();
        },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
            contentBlocks[index].url = downloadURL;
            delete contentBlocks[index].uploading;
            renderContentBlocks();
          });
        }
      );

      audioUploadInput.value = "";
    });

    // Save changes to Firestore
    saveCourseBtn.addEventListener("click", async () => {
      // Update text blocks from quill editors
      Object.entries(quillEditors).forEach(([indexStr, quill]) => {
        const idx = Number(indexStr);
        contentBlocks[idx].text = quill.root.innerHTML;
      });

      try {
        await db.collection("courses").doc(courseId).update({
          title: courseTitleInput.value,
          description: courseDescriptionInput.value,
          contentBlocks: contentBlocks,
        });
        alert("Course saved successfully!");
      } catch (error) {
        alert("Failed to save course: " + error.message);
      }
    });

    backToDashboardBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });

    loadCourse();
  </script>
</body>
</html>
